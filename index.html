<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>US Metro Outlook — 1-Year % Change</title>

<link rel="preconnect" href="https://unpkg.com">
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root { --ok:#106b21; --bad:#a2121c; --muted:#6b7280; }
body { margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:#111827; }
header { padding:14px 16px; border-bottom:1px solid #e5e7eb; background:#fafafa; display:grid; gap:6px; }
h1 { margin:0; font-size:18px; }
.muted { color:var(--muted); }

/* Tabs */
.tabs { display:flex; gap:8px; align-items:center; padding:10px 16px; border-bottom:1px solid #e5e7eb; }
.tabbtn { padding:6px 10px; border:1px solid #d1d5db; background:#fff; border-radius:8px; cursor:pointer; flex:1; }
.tabbtn.active { background:#111827; color:#fff; border-color:#111827; }

/* Map view */
#mapView { display:block; height:75vh; } /* Map is default */
#map { height:100%; width:100%; border-top:1px solid #e5e7eb; }

.controls { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px; padding:10px 16px; border-bottom:1px solid #e5e7eb; }
.card { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:10px; }
label { display:block; font-size:12px; color:#374151; margin-bottom:4px; }
select, input[type=range], input[type=text], button { width:100%; box-sizing:border-box; font:14px/1.4 inherit; }
.row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.btn { padding:8px 10px; border:1px solid #d1d5db; background:#fff; border-radius:8px; cursor:pointer; }
.btn:hover { background:#f3f4f6; }
.chips { display:flex; gap:6px; flex-wrap:wrap; }
.chip { font-size:12px; padding:4px 8px; border:1px solid #d1d5db; border-radius:999px; cursor:pointer; user-select:none; }
.chip.active { background:#111827; color:#fff; border-color:#111827; }

.wrap { overflow:auto; max-width:100vw; }
table { width:100%; border-collapse:collapse; }
th,td { padding:8px 10px; border-bottom:1px solid #e5e7eb; vertical-align:top; }
th { background:#fafafa; font-weight:600; text-align:left; position:sticky; top:0; }
tbody tr.negative { background:#fff7f7; }
tbody tr.positive { background:#f5fff6; }
.pill { display:inline-block; padding:2px 6px; border-radius:999px; font-size:12px; color:#fff; }
.pill.pos { background:var(--ok); } .pill.neg { background:var(--bad); }
tbody tr.usRow { border-top:2px solid #111827; border-bottom:2px solid #111827; background:#fffef2; }

footer { padding:10px 16px; border-top:1px solid #e5e7eb; background:#fafafa; font-size:12px; }

/* --- Dual-handle slider --- */
.range-card { display:flex; flex-direction:column; gap:8px; }
.range-wrap { position:relative; height:32px; }
.range-wrap input[type="range"] {
  position:absolute; left:0; right:0; top:0; bottom:0;
  margin:0; pointer-events:none; background:transparent; -webkit-appearance:none; appearance:none;
}
/* Track */
.range-wrap input[type="range"]::-webkit-slider-runnable-track { height:6px; border-radius:999px; background:linear-gradient(90deg,#e5e7eb,#e5e7eb); }
.range-wrap input[type="range"]::-moz-range-track { height:6px; border-radius:999px; background:#e5e7eb; }
/* Thumb */
.range-wrap input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance:none; appearance:none; pointer-events:auto;
  width:18px; height:18px; border-radius:50%; border:1px solid #374151; background:#fff;
  margin-top:-6px;
}
.range-wrap input[type="range"]::-moz-range-thumb {
  pointer-events:auto; width:18px; height:18px; border-radius:50%; border:1px solid #374151; background:#fff;
}
/* Highlight between thumbs */
.slider-track {
  position:absolute; height:6px; background:#111827; opacity:.25; border-radius:999px;
  left:0; right:0; top:50%; transform:translateY(-50%);
}
.slider-minmax { font-size:12px; color:#374151; }
</style>
</head>
<body>
<header>
  <h1>US Metro Outlook — 1-Year % Change</h1>
  <div class="muted">Data © Zillow® — <a href="https://www.zillow.com/research/data/" target="_blank" rel="noopener">Home Values Forecasts → Metro &amp; US</a>. Uses your latest CSV via <code>data/manifest.json</code>.</div>
  <div id="status" class="muted">Loading…</div>
</header>

<!-- Tabs (Map default) -->
<div class="tabs">
  <button id="tabTable" class="tabbtn" type="button">Table</button>
  <button id="tabMap" class="tabbtn active" type="button">Map</button>
</div>

<!-- Map view (default visible) -->
<div id="mapView"><div id="map"></div></div>

<!-- Table view (hidden initially) -->
<div id="tableView" style="display:none;">
  <section class="controls">
    <div class="card">
      <label for="dateSelect">Target date column</label>
      <select id="dateSelect"></select>
      <div class="chips" style="margin-top:6px">
        <span id="chipOneYear" class="chip">1-year (auto)</span>
        <span id="chipLatest" class="chip active">Latest date</span>
      </div>
    </div>

    <div class="card range-card">
      <label>Filter by 1-yr % range</label>
      <div class="range-wrap">
        <div class="slider-track" id="sliderTrack"></div>
        <input type="range" id="rangeMin" min="-30" max="30" step="0.5" value="-30">
        <input type="range" id="rangeMax" min="-30" max="30" step="0.5" value="30">
      </div>
      <div class="slider-minmax">Range: <span id="rangeLabel">-30% → 30%</span></div>
      <div class="chips" style="margin-top:6px">
        <span class="chip" data-preset="pos">Only positive</span>
        <span class="chip" data-preset="neg">Only negative</span>
        <span class="chip" data-preset="all">Reset range</span>
      </div>
    </div>

    <div class="card">
      <label for="searchBox">Search metros</label>
      <input id="searchBox" type="text" placeholder="Type metro name…">
      <div style="margin-top:8px; display:flex; gap:8px;">
        <button id="downloadCsv" class="btn">Download filtered CSV</button>
        <button id="reset" class="btn">Reset</button>
      </div>
    </div>
  </section>

  <section class="wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th data-key="NAME">Metro</th>
          <th data-key="CBSAFP">CBSA</th>
          <th data-key="base">Base value</th>
          <th data-key="target">Target value</th>
          <th data-key="pct">1-yr %</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<footer>Prepared by ABG. Green = growth (≥ 0%), Red = decline (&lt; 0%). Table is sortable — click a header.</footer>

<script>
// Config
const MANIFEST_URL = "https://raw.githubusercontent.com/adambgarrett/us-metro-zillow-widget/main/data/manifest.json";
const DATA_BASE     = "https://raw.githubusercontent.com/adambgarrett/us-metro-zillow-widget/main/data/";

// DOM
const statusEl=document.getElementById('status'), dateSelect=document.getElementById('dateSelect');
const chipOneYear=document.getElementById('chipOneYear'), chipLatest=document.getElementById('chipLatest');
const rangeMin=document.getElementById('rangeMin'), rangeMax=document.getElementById('rangeMax'), sliderTrack=document.getElementById('sliderTrack'), rangeLabel=document.getElementById('rangeLabel');
const searchBox=document.getElementById('searchBox'), resetBtn=document.getElementById('reset');
const downloadBtn=document.getElementById('downloadCsv'); const tableView=document.getElementById('tableView'); const mapView=document.getElementById('mapView');

let rawRows=[], headers=[], dateCols=[], currentDateKey=null, oneYearKey=null, rowsEnriched=[], sortKey='pct', sortDir=-1;

// helpers
const norm=s=>String(s??'').trim();
const toDate=s=>{const m=String(s||'').match(/^(\d{4})(?:-(\d{2}))?(?:-(\d{2}))?$/); if(!m)return NaN; const [_,Y,M='01',D='01']=m; return new Date(+Y,+M-1,+D);};
const detectDateColumns=cols=>cols.filter(h=>/^\d{4}(?:-\d{2})?(?:-\d{2})?$/.test(h)).sort((a,b)=>toDate(a)-toDate(b));
function findNearest(dates,target){let best=null,d=1e18;for(const k of dates){const td=toDate(k);if(isNaN(+td))continue;const diff=Math.abs(td-target);if(diff<d){d=diff;best=k;}}return best;}
function computeOneYearKey(rows){if(!rows.length)return null;const hasBase=headers.includes('BaseDate'); if(!hasBase) return dateCols.at(-1); const counts=new Map(); for(const r of rows){const bd=new Date(r.BaseDate); if(isNaN(+bd))continue; const t=new Date(bd); t.setFullYear(bd.getFullYear()+1); const near=findNearest(dateCols,t); if(near) counts.set(near,(counts.get(near)||0)+1);} let pick=null,max=0; for(const [k,v] of counts) if(v>max){max=v;pick=k;} return pick||dateCols.at(-1);}
const getName=r=>norm(r.RegionName??r.Name??r.Metro??r.MSA??r['Region Name']??'');
const getCbsa=r=>norm(r.CBSA??r.CBSAFP??r.cbsa??'');
const getTbody=()=>document.querySelector('#tbl tbody');

function enrichRows(targetKey){
  const out=[];
  for(const r of rawRows){
    const name=getName(r); if(!name) continue;
    const val=Number(r[targetKey]); if(!Number.isFinite(val)) continue;
    out.push({NAME:name, CBSAFP:getCbsa(r), base:null, target:null, pct:val, isUS:(r.RegionType==='country'||name.toLowerCase()==='united states')});
  }
  return out;
}

// ---- Range Slider logic (unified) ----
const sliderMin = Number(rangeMin.min), sliderMax = Number(rangeMax.max);
function clamp(val, lo, hi){ return Math.min(Math.max(val, lo), hi); }
function syncSlider(which){
  let a = Number(rangeMin.value), b = Number(rangeMax.value);
  if (which==='min' && a > b) { rangeMax.value = a; b = a; }
  if (which==='max' && b < a) { rangeMin.value = b; a = b; }
  const left  = ((a - sliderMin) / (sliderMax - sliderMin)) * 100;
  const right = 100 - ((b - sliderMin) / (sliderMax - sliderMin)) * 100;
  sliderTrack.style.left  = left + '%';
  sliderTrack.style.right = right + '%';
  rangeLabel.textContent = `${a}% → ${b}%`;
}
rangeMin.addEventListener('input',()=>{ syncSlider('min'); render(); });
rangeMax.addEventListener('input',()=>{ syncSlider('max'); render(); });

function render(){
  const lo = Number(rangeMin.value), hi = Number(rangeMax.value);
  const q  = norm(searchBox.value).toLowerCase();
  let usRow=null, data=[];
  for(const r of rowsEnriched){ if(r.pct<lo||r.pct>hi) continue; if(q && !r.NAME.toLowerCase().includes(q)) continue; if(r.isUS) usRow=r; else data.push(r); }
  data.sort((a,b)=>{const A=a[sortKey],B=b[sortKey]; if(A<B) return -1*sortDir; if(A>B) return 1*sortDir; return 0;});
  const makeTr=r=>`<tr class="${r.pct<0?'negative':'positive'} ${r.isUS?'usRow':''}"><td>${r.NAME}</td><td>${r.CBSAFP||''}</td><td></td><td></td><td><span class="pill ${r.pct<0?'neg':'pos'}">${r.pct.toFixed(1)}%</span></td></tr>`;
  let html=''; if(usRow) html+=makeTr(usRow); html+=data.map(makeTr).join('');
  const tbd=getTbody(); if(tbd){ tbd.innerHTML=html || `<tr><td colspan="5" class="muted">No rows match your filters.</td></tr>`; }
  const total=rowsEnriched.filter(r=>r.pct>=lo&&r.pct<=hi&&(!q||r.NAME.toLowerCase().includes(q))).length;
  statusEl.textContent=`Showing ${total.toLocaleString()} of ${rowsEnriched.length.toLocaleString()} metros — target: ${currentDateKey}`;
}

function attachSort(){
  document.querySelectorAll('th').forEach(th=>{
    th.style.cursor='pointer';
    th.addEventListener('click', ()=>{ const key=th.dataset.key; if(sortKey===key) sortDir*=-1; else { sortKey=key; sortDir=(key==='NAME'||key==='CBSAFP')?1:-1; } render(); });
  });
}

function setPreset(which){
  if(which==='pos'){ rangeMin.value = 0; rangeMax.value = 30; }
  else if(which==='neg'){ rangeMin.value = -30; rangeMax.value = -0.1; }
  else { rangeMin.value = -30; rangeMax.value = 30; }
  syncSlider();
  render();
}

async function ingestCsvText(csvText){
  const parsed=Papa.parse(csvText,{header:true,dynamicTyping:true,skipEmptyLines:true});
  rawRows=parsed.data; headers=parsed.meta.fields||Object.keys(rawRows[0]||{});
  if(!rawRows.length){statusEl.textContent='CSV parsed but contains 0 rows.';return;}
  dateCols=detectDateColumns(headers); if(!dateCols.length){statusEl.textContent='No date columns found.';return;}
  oneYearKey=computeOneYearKey(rawRows); currentDateKey=dateCols.at(-1);
  dateSelect.innerHTML=dateCols.map(c=>`<option value="${c}">${c}</option>`).join(''); dateSelect.value=currentDateKey; chipLatest.classList.add('active'); chipOneYear.classList.remove('active');
  rowsEnriched=enrichRows(currentDateKey); attachSort(); syncSlider(); render();
}

async function loadFromManifest(){
  statusEl.textContent='Loading manifest…'; const man=await fetch(MANIFEST_URL,{cache:'no-store'}).then(r=>r.json());
  const csvUrl=DATA_BASE+encodeURIComponent(man.current); statusEl.textContent='Fetching CSV…';
  const csvText=await fetch(csvUrl,{cache:'no-store'}).then(r=>r.text()); await ingestCsvText(csvText);
}

// UI wiring
document.querySelectorAll('.chip[data-preset]').forEach(el=>el.addEventListener('click',()=>setPreset(el.dataset.preset)));
chipOneYear.addEventListener('click',()=>{chipOneYear.classList.add('active');chipLatest.classList.remove('active'); if(oneYearKey){currentDateKey=oneYearKey;dateSelect.value=currentDateKey;rowsEnriched=enrichRows(currentDateKey);render();}});
chipLatest.addEventListener('click',()=>{chipLatest.classList.add('active');chipOneYear.classList.remove('active'); currentDateKey=dateCols.at(-1);dateSelect.value=currentDateKey;rowsEnriched=enrichRows(currentDateKey);render();});
[searchBox].forEach(el=>el.addEventListener('input',render));
dateSelect.addEventListener('change',()=>{chipOneYear.classList.remove('active');chipLatest.classList.remove('active'); currentDateKey=dateSelect.value; rowsEnriched=enrichRows(currentDateKey); render();});
resetBtn.addEventListener('click',()=>{
  searchBox.value=''; rangeMin.value=-30; rangeMax.value=30;
  currentDateKey=dateCols.at(-1); dateSelect.value=currentDateKey; rowsEnriched=enrichRows(currentDateKey);
  syncSlider(); render();
});
downloadBtn.addEventListener('click',()=>{
  const lo=+rangeMin.value, hi=+rangeMax.value, q=searchBox.value.trim().toLowerCase();
  const filtered=rowsEnriched.filter(r=>r.pct>=lo&&r.pct<=hi&&(!q||r.NAME.toLowerCase().includes(q)));
  const csv=[['Metro','CBSA',`Pct_${currentDateKey}`].join(','),
    ...filtered.map(r=>[`"${r.NAME.replace(/"/g,'""')}"`,`"${(r.CBSAFP||'').toString().replace(/"/g,'""')}"`,r.pct.toFixed(2)].join(','))
  ].join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`metros_filtered_${currentDateKey}.csv`; a.click(); URL.revokeObjectURL(url);
});

// Tabs & map (Map default)
let map; const tabTable=document.getElementById('tabTable'), tabMap=document.getElementById('tabMap');
function showTable(){ tabTable.classList.add('active'); tabMap.classList.remove('active'); tableView.style.display='block'; mapView.style.display='none'; }
function showMap(){ tabMap.classList.add('active'); tabTable.classList.remove('active'); tableView.style.display='none'; mapView.style.display='block';
  if(!map){ map=L.map('map').setView([37.8,-96],4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:10, attribution:'&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'}).addTo(map);
  }
  setTimeout(()=>map.invalidateSize(), 250);
}
tabTable.addEventListener('click', showTable);
tabMap.addEventListener('click', showMap);

// Start: default to Map, then load data
showMap();
loadFromManifest();
</script>
</body>
</html>
